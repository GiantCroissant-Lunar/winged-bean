# build/Taskfile.yml
version: '3'

vars:
  VERSION:
    sh: dotnet gitversion /showvariable SemVer
  FULL_VERSION:
    sh: dotnet gitversion /showvariable FullSemVer
  ARTIFACT_DIR: _artifacts/v{{.VERSION}}

tasks:
  version:
    desc: Show current GitVersion
    cmds:
      - 'echo "Version: {{.VERSION}}"'
      - 'echo "Full Version: {{.FULL_VERSION}}"'

  init-dirs:
    desc: Initialize build artifact directories
    cmds:
      - mkdir -p {{.ARTIFACT_DIR}}/dotnet/{bin,recordings,logs}
      - mkdir -p {{.ARTIFACT_DIR}}/web/{dist,recordings,logs}
      - mkdir -p {{.ARTIFACT_DIR}}/pty/{dist,logs}
      - mkdir -p {{.ARTIFACT_DIR}}/_logs

  build-dotnet:
    desc: "Build .NET projects via Nuke"
    deps: [init-dirs]
    cmds:
      - ./nuke/build.sh Compile 2>&1 | tee {{.ARTIFACT_DIR}}/_logs/dotnet-build.log
      # Adjust copy based on actual Nuke output location
      - cp -r ../bin/Release/net8.0/* {{.ARTIFACT_DIR}}/dotnet/bin/ || true

  clean:
    desc: Clean build artifacts and Task cache
    cmds:
      - rm -rf _artifacts/* .task/
